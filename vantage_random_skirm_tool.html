<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>卡牌隨機抽選器</title>
<style>
  :root{--bg:#f7fbff;--card:#fff;--ink:#10324a;--muted:#5a7b91;--accent:#3a8ad8;--chip:#e6f2ff;--ok:#1f9d55;--err:#b00020}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,"Noto Sans TC",sans-serif}
  header{padding:24px 16px;text-align:center}
  header h1{margin:0 0 6px}
  .wrap{max-width:900px;margin:0 auto;padding:0 16px 60px}
  .panel{background:var(--card);border:1px solid #e6eef7;border-radius:12px;box-shadow:0 2px 8px rgba(16,50,74,.06);padding:14px;margin-top:14px}
  .btn{border:1px solid #cfe2f3;background:var(--chip);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  input[type="text"]{width:100%;border:1px solid #cfe2f3;border-radius:10px;padding:10px;background:#fff}
  .kpi{background:#f1f7ff;border:1px dashed #cfe2f3;border-radius:10px;padding:8px 10px;display:inline-block;margin-right:10px}
  .card{position:relative;border:1px solid #e6eef7;border-radius:12px;padding:12px;background:#fff;margin-bottom:10px}
  .badge{position:absolute;right:10px;top:10px;font-size:12px;background:#fff3cd;border:1px solid #ffe08a;color:#8a6d3b;border-radius:999px;padding:2px 8px}
  .pill{display:inline-block;background:#e6f2ff;padding:2px 8px;border-radius:999px;margin-right:6px;font-size:12px}
  .tag{display:inline-block;border-radius:6px;padding:2px 6px;font-size:13px;color:#fff;margin-right:4px}
  .Move{background:#3a8ad8} .Look{background:#8e44ad} .Engage{background:#e67e22}
  .Help{background:#27ae60} .Take{background:#f1c40f;color:#000} .Overpower{background:#c0392b}
  .hint{color:var(--muted);font-size:13px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .mini{font-size:12px;color:var(--muted)}
  .excluded-item{display:flex;align-items:center;gap:8px;border:1px dashed #cfe2f3;border-radius:8px;padding:6px 8px;margin:6px 0;background:#f8fbff}
  .xbtn{margin-left:auto;border:1px solid #e4eaf2;border-radius:6px;background:#fff;cursor:pointer;padding:2px 6px}
  .row{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<header>
  <h1>卡牌隨機抽選器</h1>
  <p>改用 GitHub 文字檔 URL 匯入；排除的卡會同步出現在「抽卡歷史」。</p>
</header>

<div class="wrap">
  <!-- 1) 從 URL 匯入 -->
  <section class="panel">
    <h2>從 GitHub URL 匯入卡表</h2>
    <div class="hint">建議使用 raw 連結（例如：<code>https://raw.githubusercontent.com/用戶/倉庫/分支/cards.txt</code>）</div>
    <div class="row" style="margin-top:8px">
      <input id="srcUrl" type="text" placeholder="貼上 TXT 或 JSON 的 raw GitHub URL">
      <button id="btnFetchUrl" class="btn primary">從 URL 載入</button>
    </div>
    <div id="importMsg" class="hint" style="margin-top:6px"></div>
  </section>

  <!-- 2) 抽牌控制 -->
  <section class="panel">
    <h2>抽牌控制</h2>
    <div>
      <span class="kpi">牌庫：<span id="deckCount">0</span></span>
      <span class="kpi">剩餘：<span id="remainCount">0</span></span>
      <span class="kpi">已抽：<span id="drawnCount">0</span></span>
    </div>
    <div style="margin-top:10px">
      <button id="btnShuffle" class="btn">洗牌</button>
      <button id="btnReset" class="btn">重置</button>
      <button id="btnDraw1" class="btn primary">抽一張</button>
    </div>
  </section>

  <!-- 3) 標記已抽過（排除） -->
  <section class="panel">
    <h2>標記已抽過（排除）</h2>
    <div class="mini">輸入卡牌編號，多個請用逗號或空白分隔，例如：S002, S006 S014</div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <input id="excludeInput" type="text" placeholder="S002, S006, S014...">
      <button id="btnExclude" class="btn">加入排除</button>
      <button id="btnClearExcluded" class="btn">清空排除</button>
    </div>
    <div id="excludedList" style="margin-top:8px"></div>
  </section>

  <!-- 4) 顯示 -->
  <section class="panel">
    <h2>最新抽到</h2>
    <div id="last" class="card hint">尚未抽牌</div>
  </section>

  <section class="panel">
    <h2>抽卡歷史</h2>
    <div id="history"></div>
  </section>
</div>

<script>
const ELEMENTS=["CIRCUIT","WIND","ENERGY","FIRE","GOLD","SINEW","METAL","SAND","STONE","LEAF","WATER","WOOD"];
const GEARS=["MASK","HORN","GAUNTLET","SCEPTER","HELM","HARNESS","CLOAK","TOME","DODECAHEDRON","MANTLE","BLADE","TOOLS"];

let FULL=[],DECK=[],DRAWN=[];
const EXCLUDED=new Set(); // 被排除的 ID 集合（會視為已抽）

const $=id=>document.getElementById(id);
const deckCountEl=$("deckCount"),remainCountEl=$("remainCount"),drawnCountEl=$("drawnCount");
const historyView=$("history"),lastView=$("last"),importMsg=$("importMsg");
const excludedListEl=$("excludedList");

function toast(msg,cls="ok"){importMsg.innerHTML=`<span class="${cls}">●</span> ${msg}`;setTimeout(()=>{importMsg.textContent=""},4000);}

// 全域錯誤提示
window.addEventListener('error', e => { importMsg.innerHTML = `<span class="err">●</span> ${e.message||'未知錯誤'}`; });
window.addEventListener('unhandledrejection', e => { importMsg.innerHTML = `<span class="err">●</span> ${e.reason||'Promise 錯誤'}`; });

// --- 清理常見小錯 ---
function sanitizeText(txt){
  if(txt && txt.charCodeAt(0)===0xFEFF) txt=txt.slice(1);          // 去 BOM
  txt = txt.replace(/pair\.HORN:/g,"pair. - HORN:");                 // S017 黏字
  txt = txt.replace(/\bfore each player\b/g,"for each player");      // S097-108 fore -> for
  // 元素前若缺 " - "：補上
  const elemPat = "(?:" + ELEMENTS.join("|") + ")";
  txt = txt.replace(new RegExp("(\\])\\s+("+elemPat+"):", "g"), "] - $2:");
  return txt;
}

// --- 解析 ---
function parseLine(line){
  const idMatch = line.match(/^S(\d{3})/i);
  const speedMatch = line.match(/Speed\s+(\d{1,2})/i);
  if(!idMatch || !speedMatch) return null;

  let elemName = null, elemIdx = -1;
  for(const e of ELEMENTS){
    const idx = line.indexOf(e + ":");
    if(idx !== -1 && (elemIdx === -1 || idx < elemIdx)){ elemIdx = idx; elemName = e; }
  }
  if(elemIdx === -1) return null;

  let gearName = null, gearIdx = -1;
  for(const g of GEARS){
    const idx = line.lastIndexOf(g + ":");
    if(idx > gearIdx){ gearIdx = idx; gearName = g; }
  }
  if(gearIdx === -1) return null;

  // 只在元素段「之前」擷取技能
  const skillRegion = line.slice(0, elemIdx);
  const rawSkills = Array.from(skillRegion.matchAll(/\[([^\]]+)\]/g)).map(m => m[1].trim());

  const SKILL_SET = new Set(["Move","Look","Engage","Help","Take","Overpower"]);
  const skills = Array.from(new Set(
    rawSkills.map(s => s[0].toUpperCase() + s.slice(1).toLowerCase())
             .filter(s => SKILL_SET.has(s))
  ));

  const elementText = line.slice(elemIdx + (elemName.length + 1), gearIdx).replace(/^\s*-\s*/,'').trim();
  const gearText = line.slice(gearIdx + (gearName.length + 1)).trim();

  return {
    id: "S" + idMatch[1],
    speed: Number(speedMatch[1]),
    skills,
    element: elemName,
    elementText,
    gear: gearName,
    gearText,
    raw: line.trim()
  };
}
function parseTXT(txt){
  txt=sanitizeText(txt);
  const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const cards=[]; for(const ln of lines){ const c=parseLine(ln); if(c) cards.push(c); }
  return cards;
}
function parseJSON(txt){
  const data=JSON.parse(sanitizeText(txt));
  return Array.isArray(data)?data:(data.cards||[]);
}

// --- Render ---
const PRIORITY_EMOJI = "⚡"; // 第二列（優先發動）標示
function renderSkills(skills){
  return skills.map((s,i)=>{
    const label = (i===1 ? `${PRIORITY_EMOJI} ${s}` : s);
    return `<span class="tag ${s}" title="${i===1?'優先發動':'計分技能'}">${label}</span>`;
  }).join(" ");
}
function renderCard(c){
  const el=document.createElement("div"); el.className="card";
  el.innerHTML=`<h3>${c.id} · Speed ${c.speed}</h3>
  <div>${renderSkills(c.skills)}</div>
  <div><span class="pill">${c.element}</span> ${c.elementText}</div>
  <div><span class="pill">${c.gear}</span> ${c.gearText}</div>`;
  if(c._excluded) el.innerHTML += `<div class="badge">先前已抽（排除）</div>`;
  return el;
}
function refreshStats(){
  deckCountEl.textContent=FULL.length;
  remainCountEl.textContent=DECK.length;
  drawnCountEl.textContent=DRAWN.length;
}
function resetDeck(){
  // 將 FULL 建立新 DECK，扣掉 EXCLUDED
  DECK = FULL.filter(c=>!EXCLUDED.has(c.id));
  // 從 DRAWN 中移除目前不在 EXCLUDED 且非實際抽出的「歷史（排除來源）」項
  DRAWN = DRAWN.filter(c => !c._excluded || EXCLUDED.has(c.id));
  refreshStats();
  lastView.textContent="尚未抽牌";
  historyView.innerHTML="";
  // 重新渲染歷史
  DRAWN.forEach(c=>historyView.prepend(renderCard(c)));
  renderExcludedList();
}

// --- 抽牌 ---
function drawOne(){
  if(!DECK.length){toast("牌庫空","err");return;}
  const idx=Math.floor(Math.random()*DECK.length);
  const c=DECK.splice(idx,1)[0];
  DRAWN.push(c);
  lastView.innerHTML=""; lastView.appendChild(renderCard(c));
  const h=renderCard(c); historyView.prepend(h);
  refreshStats();
}

// ========== 從 URL 匯入 ==========
async function fetchFromUrl(url){
  try{
    importMsg.innerHTML = "⏳ 嘗試載入中…";
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const ct = (res.headers.get("content-type")||"").toLowerCase();
    const text = await res.text();
    let cards = [];
    if(ct.includes("application/json") || url.toLowerCase().endsWith(".json")){
      cards = parseJSON(text);
    }else{
      cards = parseTXT(text);
    }
    if(!cards.length) throw new Error("解析不到卡牌資料，請確認檔案內容格式");
    FULL = cards;
    toast(`已從 URL 匯入 ${cards.length} 張`);
    resetDeck();
  }catch(e){
    importMsg.innerHTML = `<span class="err">●</span> 載入失敗：${e.message}（若是 GitHub，一般需使用 <b>raw</b> 連結）`;
  }
}
$("btnFetchUrl").onclick = ()=>{
  const url = $("srcUrl").value.trim();
  if(!url){ toast("請輸入 URL","err"); return; }
  fetchFromUrl(url);
};

// --- 洗牌/重置 ---
$("btnShuffle").onclick=()=>{ DECK.sort(()=>Math.random()-0.5); toast("已洗牌"); };
$("btnReset").onclick=resetDeck;
$("btnDraw1").onclick=drawOne;

// ================== 排除功能 ==================
function normalizeIds(input){
  return input.split(/[,\s]+/).map(s=>s.trim().toUpperCase()).filter(Boolean);
}
function excludeByIds(ids){
  let added=0, notFound=[];
  const fullIds=new Set(FULL.map(c=>c.id));
  ids.forEach(id=>{
    if(!/^S\d{3}$/.test(id)) return; // 格式不合跳過
    if(!fullIds.has(id)) { notFound.push(id); return; }
    if(!EXCLUDED.has(id)){
      EXCLUDED.add(id);
      // 從牌庫移除
      const idx = DECK.findIndex(c=>c.id===id);
      if(idx>-1) DECK.splice(idx,1);
      // 若尚未在歷史，加入一筆「先前已抽（排除）」的記錄
      if(!DRAWN.some(c=>c.id===id)){
        const base = FULL.find(c=>c.id===id);
        if(base){
          const ghost = {...base, _excluded:true}; // 標記
          DRAWN.push(ghost);
          historyView.prepend(renderCard(ghost));
        }
      }
      added++;
    }
  });
  if(added>0){ toast(`已排除 ${added} 張`); }
  if(notFound.length){ importMsg.innerHTML = `<span class="err">●</span> 找不到：${notFound.join(", ")}`; }
  refreshStats();
  renderExcludedList();
}
function clearExcluded(){
  // 從歷史中移除 _excluded 的項目
  DRAWN = DRAWN.filter(c=>!c._excluded);
  EXCLUDED.clear();
  toast("已清空排除");
  resetDeck();
}
function renderExcludedList(){
  excludedListEl.innerHTML="";
  if(EXCLUDED.size===0){
    excludedListEl.innerHTML = `<div class="hint">目前沒有被排除的卡牌。</div>`;
    return;
  }
  const byId = new Map(FULL.map(c=>[c.id,c]));
  Array.from(EXCLUDED).sort().forEach(id=>{
    const c = byId.get(id);
    const div = document.createElement("div");
    div.className = "excluded-item";
    div.innerHTML = `<strong>${id}</strong> <span class="mini">${c? `Speed ${c.speed} · ${c.skills.join(" / ")}` : ""}</span>
                     <button class="xbtn" data-id="${id}" title="取消排除">✖</button>`;
    excludedListEl.appendChild(div);
  });
  // 綁定取消排除
  excludedListEl.querySelectorAll(".xbtn").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-id");
      if(!EXCLUDED.has(id)) return;
      EXCLUDED.delete(id);
      // 從歷史中移除對應的「排除來源」紀錄
      const idxHist = DRAWN.findIndex(x=>x.id===id && x._excluded);
      if(idxHist>-1) DRAWN.splice(idxHist,1);
      // 放回牌庫（未抽出的狀態）
      const c = FULL.find(x=>x.id===id);
      if(c) DECK.push(c);
      toast(`已取消排除 ${id}`);
      refreshStats();
      renderExcludedList();
      // 重新渲染歷史
      historyView.innerHTML="";
      DRAWN.forEach(x=>historyView.prepend(renderCard(x)));
    };
  });
}

// 綁定排除按鈕
$("btnExclude").onclick = ()=>{
  const ids = normalizeIds($("excludeInput").value);
  if(ids.length===0){ toast("請輸入卡牌編號","err"); return; }
  excludeByIds(ids);
  $("excludeInput").value="";
};
$("btnClearExcluded").onclick = clearExcluded;

// ===== 啟動：若網址有 ?src= 也自動載入 =====
(function initFromQuery(){
  const url=new URL(location.href);
  const src=url.searchParams.get("src");
  if(src){ $("srcUrl").value=src; fetchFromUrl(src); }
})();
</script>
</body>
</html>

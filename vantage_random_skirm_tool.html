<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>卡牌隨機抽選器</title>
<style>
  :root{--bg:#f7fbff;--card:#fff;--ink:#10324a;--muted:#5a7b91;--accent:#3a8ad8;--chip:#e6f2ff;--ok:#1f9d55;--err:#b00020}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,"Noto Sans TC",sans-serif}
  header{padding:24px 16px;text-align:center}
  header h1{margin:0 0 6px}
  .wrap{max-width:900px;margin:0 auto;padding:0 16px 60px}
  .panel{background:var(--card);border:1px solid #e6eef7;border-radius:12px;box-shadow:0 2px 8px rgba(16,50,74,.06);padding:14px;margin-top:14px}
  .btn{border:1px solid #cfe2f3;background:var(--chip);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  input[type="file"],textarea{width:100%}
  textarea{min-height:120px;border:1px solid #cfe2f3;border-radius:10px;padding:10px;background:#fafcff;font-family:ui-monospace}
  .kpi{background:#f1f7ff;border:1px dashed #cfe2f3;border-radius:10px;padding:8px 10px;display:inline-block;margin-right:10px}
  .card{border:1px solid #e6eef7;border-radius:12px;padding:12px;background:#fff;margin-bottom:10px}
  .pill{display:inline-block;background:#e6f2ff;padding:2px 8px;border-radius:999px;margin-right:6px;font-size:12px}
  .tag{display:inline-block;border-radius:6px;padding:2px 6px;font-size:13px;color:#fff;margin-right:4px}
  .Move{background:#3a8ad8} .Look{background:#8e44ad} .Engage{background:#e67e22}
  .Help{background:#27ae60} .Take{background:#f1c40f;color:#000} .Overpower{background:#c0392b}
  .hint{color:var(--muted);font-size:13px}
  .ok{color:var(--ok)} .err{color:var(--err)}
</style>
</head>
<body>
<header>
  <h1>卡牌隨機抽選器</h1>
  <p>支援 TXT / JSON 匯入，點一下即可抽一張。</p>
</header>

<div class="wrap">
  <section class="panel">
    <h2>匯入資料</h2>
    <input id="file" type="file" accept=".txt,.json" />
    <textarea id="raw" placeholder="貼上 TXT 或 JSON 內容"></textarea>
    <div>
      <button id="btnImportText" class="btn primary">匯入</button>
    </div>
    <div id="importMsg" class="hint"></div>
  </section>

  <section class="panel">
    <h2>抽牌控制</h2>
    <div>
      <span class="kpi">牌庫：<span id="deckCount">0</span></span>
      <span class="kpi">剩餘：<span id="remainCount">0</span></span>
      <span class="kpi">已抽：<span id="drawnCount">0</span></span>
    </div>
    <div style="margin-top:10px">
      <button id="btnShuffle" class="btn">洗牌</button>
      <button id="btnReset" class="btn">重置</button>
      <button id="btnDraw1" class="btn primary">抽一張</button>
    </div>
  </section>

  <section class="panel">
    <h2>最新抽到</h2>
    <div id="last" class="card hint">尚未抽牌</div>
  </section>

  <section class="panel">
    <h2>抽卡歷史</h2>
    <div id="history"></div>
  </section>
</div>

<script>
const ELEMENTS=["CIRCUIT","WIND","ENERGY","FIRE","GOLD","SINEW","METAL","SAND","STONE","LEAF","WATER","WOOD"];
const GEARS=["MASK","HORN","GAUNTLET","SCEPTER","HELM","HARNESS","CLOAK","TOME","DODECAHEDRON","MANTLE","BLADE","TOOLS"];
let FULL=[],DECK=[],DRAWN=[];
const $=id=>document.getElementById(id);
const deckCountEl=$("deckCount"),remainCountEl=$("remainCount"),drawnCountEl=$("drawnCount");
const deckView=$("deckView"),historyView=$("history"),lastView=$("last"),importMsg=$("importMsg");

function toast(msg,cls="ok"){importMsg.innerHTML=`<span class="${cls}">●</span> ${msg}`;setTimeout(()=>importMsg.textContent="",2000);}
function sanitizeText(txt){if(txt.charCodeAt(0)===0xFEFF)txt=txt.slice(1);txt=txt.replace(/pair\.HORN:/g,"pair. - HORN:");return txt;}
function parseLine(line){
  const idMatch = line.match(/^S(\d{3})/i);
  const speedMatch = line.match(/Speed\s+(\d{1,2})/i);
  if(!idMatch || !speedMatch) return null;

  // 先找元素與裝備位置
  const ELEMENTS = ["CIRCUIT","WIND","ENERGY","FIRE","GOLD","SINEW","METAL","SAND","STONE","LEAF","WATER","WOOD"];
  const GEARS = ["MASK","HORN","GAUNTLET","SCEPTER","HELM","HARNESS","CLOAK","TOME","DODECAHEDRON","MANTLE","BLADE","TOOLS"];

  let elemName = null, elemIdx = -1;
  for(const e of ELEMENTS){
    const idx = line.indexOf(e + ":");
    if(idx !== -1 && (elemIdx === -1 || idx < elemIdx)){ elemIdx = idx; elemName = e; }
  }
  if(elemIdx === -1) return null;

  let gearName = null, gearIdx = -1;
  for(const g of GEARS){
    const idx = line.lastIndexOf(g + ":");
    if(idx > gearIdx){ gearIdx = idx; gearName = g; }
  }
  if(gearIdx === -1) return null;

  // ✅ 只在元素段「之前」擷取技能，避免撈到元素敘述裡的 [Move]
  const skillRegion = line.slice(0, elemIdx);
  const rawSkills = Array.from(skillRegion.matchAll(/\[([^\]]+)\]/g)).map(m => m[1].trim());

  // 正規化 + 過濾 + 去重（只允許 6 種技能）
  const SKILL_SET = new Set(["Move","Look","Engage","Help","Take","Overpower"]);
  const skills = Array.from(new Set(
    rawSkills.map(s => s[0].toUpperCase() + s.slice(1).toLowerCase()) // 轉成首字大寫
             .filter(s => SKILL_SET.has(s))
  ));

  // 元素/裝備文字
  const elementText = line.slice(elemIdx + (elemName.length + 1), gearIdx).replace(/^\s*-\s*/,'').trim();
  const gearText = line.slice(gearIdx + (gearName.length + 1)).trim();

  return {
    id: "S" + idMatch[1],
    speed: Number(speedMatch[1]),
    skills,
    element: elemName,
    elementText,
    gear: gearName,
    gearText,
    raw: line.trim()
  };
}
function parseTXT(txt){txt=sanitizeText(txt);const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const cards=[];for(const ln of lines){const c=parseLine(ln);if(c)cards.push(c);}return cards;}
function parseJSON(txt){const data=JSON.parse(sanitizeText(txt));return Array.isArray(data)?data:data.cards||[];}
function renderSkills(skills){return skills.map(s=>`<span class="tag ${s}">${s}</span>`).join(" ");}
function renderCard(c){const el=document.createElement("div");el.className="card";
  el.innerHTML=`<h3>${c.id} · Speed ${c.speed}</h3>
  <div>${renderSkills(c.skills)}</div>
  <div><span class="pill">${c.element}</span> ${c.elementText}</div>
  <div><span class="pill">${c.gear}</span> ${c.gearText}</div>`;return el;}
function refreshStats(){deckCountEl.textContent=FULL.length;remainCountEl.textContent=DECK.length;drawnCountEl.textContent=DRAWN.length;}
function resetDeck(){DECK=FULL.slice();DRAWN=[];refreshStats();lastView.textContent="尚未抽牌";historyView.innerHTML="";}
function drawOne(){
  if(!DECK.length){toast("牌庫空","err");return;}
  const idx=Math.floor(Math.random()*DECK.length);const c=DECK.splice(idx,1)[0];
  DRAWN.push(c);lastView.innerHTML="";lastView.appendChild(renderCard(c));
  const h=renderCard(c);historyView.prepend(h);refreshStats();
}
$("btnImportText").onclick=()=>{
  const raw=$("raw").value.trim();if(!raw){toast("無內容","err");return;}
  try{FULL=parseJSON(raw);resetDeck();toast("JSON 匯入成功");}
  catch{FULL=parseTXT(raw);if(FULL.length)resetDeck(),toast("TXT 匯入成功");else toast("解析失敗","err");}
};
$("file").onchange=e=>{const f=e.target.files[0];if(!f)return;f.text().then(t=>{if(f.name.endsWith(".json"))FULL=parseJSON(t);else FULL=parseTXT(t);resetDeck();toast("匯入成功");});};
$("btnShuffle").onclick=()=>{DECK.sort(()=>Math.random()-0.5);toast("已洗牌");};
$("btnReset").onclick=resetDeck;
$("btnDraw1").onclick=drawOne;
</script>
</body>
</html>

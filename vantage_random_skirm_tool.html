<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vantage Skirm Card Pool</title>
<style>
  :root{
    --bg:#f0f3f8;--card:#fff;--ink:#10324a;--muted:#5a7b91;--accent:#3a8ad8;--chip:#e6f2ff;
    --ok:#1f9d55;--err:#b00020;--radius:12px;
    --bigW:320px;   /* 大卡寬（桌面版放大一點） */
    --miniW:200px;  /* 小卡寬（桌面版放大一點） */
    --colLeft:380px;/* 左側欄固定寬 */
    --pageW:1280px; /* 全站固定寬 */
  }

  /* 固定為桌面配置：不做窄螢幕適配 */
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,"Noto Sans TC",Arial,Helvetica,sans-serif;
    display:flex;flex-direction:column;min-width:1280px;
  }

  /* Header / Footer */
  .site-header{background:#2d3340;color:#fff;text-align:center;padding:22px 16px}
  .site-header h1{margin:0 0 6px;font-size:28px;letter-spacing:.3px}
  .site-header p{margin:0;font-size:14px;color:#dfe7f1}

  .site-footer{margin-top:auto;text-align:center;padding:22px 16px;background:#2d3340;color:#fff}
  .site-footer .back-button{
    display:inline-block;margin-top:12px;padding:12px 20px;background:#28a745;color:#fff;
    text-decoration:none;border-radius:8px;font-weight:700;transition:background .2s, box-shadow .2s
  }
  .site-footer .back-button:hover{background:#218838;box-shadow:0 4px 8px rgba(0,0,0,.2)}

  /* Desktop layout: 左欄固定、右欄自動 */
  .wrap{
    width:var(--pageW); margin:0 auto; padding:20px 18px 60px;
    display:grid; grid-template-columns: var(--colLeft) 1fr; gap:18px;
  }

  .panel{
    background:var(--card);border:1px solid #e6eef7;border-radius:var(--radius);
    box-shadow:0 2px 8px rgba(16,50,74,.06);padding:16px;
  }
  .panel h2{margin:0 0 12px;font-size:18px}

  .btn{border:1px solid #cfe2f3;background:var(--chip);padding:10px 14px;border-radius:10px;cursor:pointer;font-size:14px}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.ghost{background:#fff}
  .controls-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .kpi-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
  .kpi{background:#f1f7ff;border:1px dashed #cfe2f3;border-radius:10px;padding:8px 10px;display:inline-block;font-size:14px}
  .mini{font-size:12px;color:var(--muted)}
  input[type="text"]{flex:1 1 auto;min-width:220px;border:1px solid #cfe2f3;border-radius:10px;padding:10px;background:#fff;font-size:14px}

  /* Card ratio 63:88 */
  .card{
    position:relative;
    width:var(--bigW);aspect-ratio:63/88;border:1px solid #dfe7f1;border-radius:16px;
    background:#fff;padding:12px;box-shadow:0 6px 18px rgba(16,50,74,.08);
    display:flex;flex-direction:column;overflow:hidden
  }
  .card--mini{
    width:var(--miniW);aspect-ratio:63/88;padding:10px;border-radius:14px;
    box-shadow:0 3px 10px rgba(16,50,74,.06);display:flex;flex-direction:column;
    cursor:pointer;transition:transform .05s ease
  }
  .card--mini:active{transform:scale(0.99)}

  .badge{position:absolute;right:10px;top:36px;font-size:12px;background:#fff3cd;border:1px solid #ffe08a;color:#8a6d3b;border-radius:999px;padding:2px 8px;z-index:3}

  /* Fixed info: Speed / ID */
  .speed-badge{
    position:absolute; right:10px; top:8px;
    font-size:26px; font-weight:800; color:var(--ink); line-height:1; z-index:4;
  }
  .card--mini .speed-badge{top:6px; right:8px; font-size:16px}

  .card-id{
    position:absolute; right:10px; bottom:6px;
    font-size:11px; color:var(--muted); line-height:1; z-index:4;
  }
  .card--mini .card-id{right:8px; bottom:6px; font-size:10px}

  /* Skills row（桌面：不滾動，超出就隱藏） */
  .skills{display:flex;gap:6px;flex-wrap:nowrap;overflow:hidden;white-space:nowrap;margin-right:64px}
  .tag{display:inline-block;border-radius:6px;padding:5px 10px;font-size:15px;color:#fff;margin-right:0}
  .Move{background:#3a8ad8}.Look{background:#8e44ad}.Engage{background:#e67e22}
  .Help{background:#27ae60}.Take{background:#f1c40f;color:#000}.Overpower{background:#c0392b}
  .card--mini .tag{font-size:11px;padding:3px 6px}

  .pill{display:inline-flex;align-items:center;gap:6px;background:#e6f2ff;padding:4px 10px;border-radius:999px;margin-right:6px;font-size:13px;white-space:nowrap}
  .card--mini .pill{font-size:11px;padding:3px 8px}

  .elem-badge img{width:18px;height:18px;vertical-align:-3px;border-radius:3px;object-fit:cover}
  .spacer{flex:1 1 auto}
  .line{font-size:15px}
  .card--mini .line{font-size:12px}

  /* Right column layout: 最新一張 + 歷史區塊 置右 */
  .right-col{display:grid; grid-template-rows: auto 1fr; gap:18px; align-content:start}
  .latest-wrap{display:flex; gap:18px; align-items:flex-start}
  .latest-card-box{display:flex;align-items:flex-start;gap:16px}

  /* Draw History grid */
  .history-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--miniW),1fr));gap:14px}

  /* Excluded list */
  .excluded-list .row,.excluded-item{display:flex;align-items:center;gap:8px;border:1px dashed #cfe2f3;border-radius:8px;padding:6px 8px;margin:6px 0;background:#f8fbff}
  .xbtn{margin-left:auto;border:1px solid #e4eaf2;border-radius:6px;background:#fff;cursor:pointer;padding:2px 6px}

  /* Desktop-only cosmetic tweak for panel titles */
  .panel h2{letter-spacing:.2px}
</style>
</head>
<body>
<header class="site-header">
  <h1>Vantage Skirm Card Pool</h1>
  <p>Auto-imports on load. Excluded cards appear in Draw History.</p>
</header>

<div class="wrap">
  <!-- Left column: controls -->
  <div class="left-col" style="display:flex;flex-direction:column;gap:18px">
    <section class="panel">
      <h2>Mark Previously Drawn (Exclude)</h2>
      <div class="mini" style="margin-bottom:8px">Enter card IDs separated by comma or space (e.g., <code>S002 S006</code>)</div>
      <div class="controls-row">
        <input id="excludeInput" type="text" placeholder="S002, S006..." />
        <button id="btnExclude" class="btn">Add</button>
        <button id="btnClearExcluded" class="btn">Clear</button>
      </div>
      <div id="excludedList" class="excluded-list"></div>
    </section>

    <section class="panel">
      <h2>Draw Controls</h2>
      <div class="kpi-row">
        <span class="kpi">Deck: <span id="deckCount">0</span></span>
        <span class="kpi">Remaining: <span id="remainCount">0</span></span>
        <span class="kpi">Drawn: <span id="drawnCount">0</span></span>
      </div>
      <div class="controls-row">
        <button id="btnShuffle" class="btn">Shuffle</button>
        <button id="btnReset" class="btn">Reset</button>
        <button id="btnDraw1" class="btn primary">Draw</button>
        <button id="btnDownload" class="btn ghost">Download JPG</button>
      </div>
    </section>
  </div>

  <!-- Right column: latest + history -->
  <div class="right-col">
    <section class="panel latest-wrap">
      <div style="min-width:var(--bigW)">
        <h2 style="margin-bottom:12px">Latest Draw</h2>
        <div id="last" class="mini">No card drawn yet</div>
      </div>
      <!-- 可加說明或下一步按鈕的位置 -->
    </section>

    <section class="panel">
      <h2>Draw History</h2>
      <div id="history" class="history-grid"></div>
    </section>
  </div>
</div>

<footer class="site-footer">
  <p>&copy; 2025 Boardgame Tools</p>
  <a href="index.html" class="back-button">Back to Home</a>
</footer>

<script>
/* ===== Constants ===== */
const ELEMENTS=["CIRCUIT","WIND","ENERGY","FIRE","GOLD","SINEW","METAL","SAND","STONE","LEAF","WATER","WOOD"];
const GEARS=["MASK","HORN","GAUNTLET","SCEPTER","HELM","HARNESS","CLOAK","TOME","DODECAHEDRON","MANTLE","BLADE","TOOLS"];
const SKILL_COLORS={Move:"#3a8ad8",Look:"#8e44ad",Engage:"#e67e22",Help:"#27ae60",Take:"#f1c40f",Overpower:"#c0392b"};
const GEAR_EMOJI="⚡";

/* Element color + icon URL */
const ELEMENT_STYLE={
  CIRCUIT:{color:"#7cc6ff",icon:"https://zak5325.github.io/vantage_element_icon/i-circuit.png"},
  WIND   :{color:"#ff9dc8",icon:"https://zak5325.github.io/vantage_element_icon/i-wind.png"},
  ENERGY :{color:"#b990ff",icon:"https://zak5325.github.io/vantage_element_icon/i-energy.png"},
  FIRE   :{color:"#ffa733",icon:"https://zak5325.github.io/vantage_element_icon/i-fire.png"},
  GOLD   :{color:"#f6c85f",icon:"https://zak5325.github.io/vantage_element_icon/i-gold.png"},
  SINEW  :{color:"#ff8a8a",icon:"https://zak5325.github.io/vantage_element_icon/i-sinew.png"},
  METAL  :{color:"#c1d6e3",icon:"https://zak5325.github.io/vantage_element_icon/i-metal.png"},
  SAND   :{color:"#f0caa6",icon:"https://zak5325.github.io/vantage_element_icon/i-sand.png"},
  STONE  :{color:"#a9b7c4",icon:"https://zak5325.github.io/vantage_element_icon/i-stone.png"},
  LEAF   :{color:"#74d37e",icon:"https://zak5325.github.io/vantage_element_icon/i-leaf.png"},
  WATER  :{color:"#6bb6ff",icon:"https://zak5325.github.io/vantage_element_icon/i-water.png"},
  WOOD   :{color:"#c48f62",icon:"https://zak5325.github.io/vantage_element_icon/i-wood.png"}
};

/* Source */
const DEFAULT_PRIMARY="https://raw.githubusercontent.com/zak5325/zak5325.github.io/main/skirm_cardlist.txt";

/* State */
let FULL=[],DECK=[],DRAWN=[];
const EXCLUDED=new Set();
let CURRENT_BIG_CARD=null;

/* DOM */
const $=id=>document.getElementById(id);
const deckCountEl=$("deckCount"),remainCountEl=$("remainCount"),drawnCountEl=$("drawnCount");
const historyView=$("history"),lastView=$("last"),excludedListEl=$("excludedList");

/* ===== Preload icons to base64 (so JPG will keep them) ===== */
let ICONS_READY = null;
async function blobToDataURL(blob){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(blob);});}
async function preloadElementIcons(){
  await Promise.all(Object.values(ELEMENT_STYLE).map(async st=>{
    if(!st.icon) return;
    try{const r=await fetch(st.icon,{mode:"cors"});if(!r.ok) throw 0;st.iconData=await blobToDataURL(await r.blob());}
    catch{st.iconData=null;}
  }));
}
ICONS_READY = preloadElementIcons();

/* ===== Parse ===== */
function sanitizeText(t){if(t && t.charCodeAt(0)===0xFEFF) t=t.slice(1);return t;}
function parseLine(l){
  const id=l.match(/^S(\d{3})/i);const sp=l.match(/Speed\s+(\d{1,2})/i);
  if(!id||!sp)return null;
  let e=null,ei=-1,g=null,gi=-1;
  for(const x of ELEMENTS){const p=l.indexOf(x+":");if(p!=-1&&(ei==-1||p<ei)){ei=p;e=x;}}if(ei===-1)return null;
  for(const x of GEARS){const p=l.lastIndexOf(x+":");if(p>gi){gi=p;g=x;}}if(gi===-1)return null;
  // skills: de-duplicate, keep order
  const rawSkills=Array.from(l.matchAll(/\[([^\]]+)\]/g)).map(m=>m[1].trim());
  const seen=new Set(); const skills=[];
  for(const s of rawSkills){ if(!seen.has(s)){ seen.add(s); skills.push(s); } }
  const et=l.slice(ei+(e.length+1),gi).replace(/^\s*-\s*/,'').trim();
  const gt=l.slice(gi+(g.length+1)).trim();
  return{id:"S"+id[1],speed:+sp[1],skills,element:e,elementText:et,gear:g,gearText:gt};
}
function parseTXT(t){return sanitizeText(t).split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(parseLine).filter(Boolean);}

/* ===== Render (page) ===== */
function renderSkills(skills){
  return `<div class="skills">`+skills.map(s=>`<span class="tag ${s}">${s}</span>`).join("")+`</div>`;
}
function elementBadgeHTML(elemName){
  const st = ELEMENT_STYLE[elemName] || {};
  const icon = st.icon ? `<img src="${st.icon}" alt="${elemName}">` : "";
  return `<span class="elem-badge pill">${icon}${elemName}</span>`;
}
function renderCard(c,{mini=false}={}){
  const el=document.createElement("div");
  el.className="card"+(mini?" card--mini":"");

  // Fixed-position overlays
  const speedHTML = `<div class="speed-badge">${c.speed}</div>`;
  const idHTML    = `<div class="card-id">${c.id}</div>`;

  el.innerHTML=`
    ${speedHTML}
    ${renderSkills(c.skills)}
    <div class="spacer"></div>
    <div class="line">${elementBadgeHTML(c.element)} ${c.elementText}</div>
    <div class="line"><span class="pill">${GEAR_EMOJI} ${c.gear}</span> ${c.gearText}</div>
    ${idHTML}
  `;
  if(c._excluded)el.innerHTML+=`<div class="badge">Previously drawn (excluded)</div>`;
  if(mini){el.title="Click to preview as big card";el.onclick=()=>showAsBigCard(c);}
  return el;
}

/* ===== Deck / State ===== */
function refreshStats(){deckCountEl.textContent=FULL.length;remainCountEl.textContent=DECK.length;drawnCountEl.textContent=DRAWN.filter(c=>!c._excluded).length;}
function resetDeck(){
  DECK=FULL.filter(c=>!EXCLUDED.has(c.id));
  DRAWN=Array.from(EXCLUDED).map(id=>({...FULL.find(c=>c.id===id),_excluded:true})).filter(Boolean);
  lastView.textContent="No card drawn yet";historyView.innerHTML="";
  DRAWN.forEach(c=>historyView.prepend(renderCard(c,{mini:true})));
  refreshStats();
}
function showAsBigCard(c){CURRENT_BIG_CARD=c;lastView.innerHTML="";lastView.append(renderCard(c));}
function drawOne(){if(!DECK.length)return;const i=Math.floor(Math.random()*DECK.length);const c=DECK.splice(i,1)[0];DRAWN.push(c);showAsBigCard(c);historyView.prepend(renderCard(c,{mini:true}));refreshStats();}
$("btnShuffle").onclick=()=>DECK.sort(()=>Math.random()-0.5);
$("btnReset").onclick=resetDeck;
$("btnDraw1").onclick=drawOne;
$("btnExclude").onclick=()=>{const raw=$("excludeInput").value.trim();if(!raw)return;raw.split(/[,\s]+/).forEach(id=>{if(id)EXCLUDED.add(id.toUpperCase());});$("excludeInput").value="";resetDeck();};
$("btnClearExcluded").onclick=()=>{EXCLUDED.clear();resetDeck();};

(async()=>{
  try{const r=await fetch(DEFAULT_PRIMARY,{cache:"no-store"});if(!r.ok)throw new Error(`HTTP ${r.status}`);FULL=parseTXT(await r.text());resetDeck();}
  catch(e){console.error("Failed to load card list:",e);}
})();

/* ===== JPG Export (layout mirrors page) ===== */
const MEASURE_CANVAS=document.createElement("canvas");
const CTX=MEASURE_CANVAS.getContext("2d");
function textWidthPx(text, font){ try{CTX.font=font;return CTX.measureText(String(text||"")).width;}catch{return String(text||"").length*11.5;} }

/* skills single row (auto scale to fit) */
function skillRowSVG(skills, x, y, maxW){
  const height=34, padX=12, gap=8;
  const font="15px system-ui, sans-serif";
  const items = skills.map(s=>{
    const w=padX*2 + textWidthPx(s,font);
    return {s, w, color:SKILL_COLORS[s]||"#999", textColor:(s==="Take")?"#000":"#fff"};
  });
  const totalW = items.reduce((a,b)=>a+b.w,0) + gap*(Math.max(items.length-1,0));
  const scale = Math.min(1, maxW/totalW);
  let out=`<g transform="translate(${x},${y}) scale(${scale})">`;
  let cursor=0;
  items.forEach(it=>{
    out += `<rect x="${cursor}" y="0" rx="7" ry="7" width="${it.w}" height="${height}" fill="${it.color}"/>`;
    out += `<text x="${cursor+padX}" y="22" font-size="15" font-family="system-ui, sans-serif" fill="${it.textColor}">${it.s}</text>`;
    cursor += it.w + gap;
  });
  out += `</g>`;
  return {svg:out};
}

/* wrap with first-line indent */
function wrapWithFirstIndentByPx(text, firstIndentPx, lineWidthPx, fontPx=20){
  const font=`${fontPx}px system-ui, sans-serif`;
  const words=String(text||"").split(/\s+/);
  const lines=[]; let cur=""; let limit=lineWidthPx-firstIndentPx; let first=true;
  for(const w of words){
    const candidate=(cur?cur+" ":"")+w;
    if(textWidthPx(candidate,font)<=limit){cur=candidate;}
    else{ if(cur)lines.push(cur); cur=w; if(first){first=false;limit=lineWidthPx;} }
  }
  if(cur)lines.push(cur);
  return lines;
}

/* pill generators */
function pillWithIconSVG({x,y,text,iconData,fontSize=22,bg="#e6f2ff",textColor="#10324a",padX=12,padY=8,iconSize=22,gap=8,rx=14,fontWeight=700}){
  const font=`${fontWeight} ${fontSize}px system-ui, sans-serif`;
  const textW = textWidthPx(text, font);
  const w = padX*2 + (iconData?iconSize+gap:0) + textW;
  const h = padY*2 + Math.max(iconSize,fontSize);
  const baseY = y + padY + Math.max(iconSize,fontSize) - 5;
  let svg=`<rect x="${x}" y="${y}" rx="${rx}" ry="${rx}" width="${w}" height="${h}" fill="${bg}" />`;
  if(iconData) svg+=`<image href="${iconData}" x="${x+padX}" y="${y+(h-iconSize)/2}" width="${iconSize}" height="${iconSize}" preserveAspectRatio="xMidYMid slice" />`;
  const textX = x + padX + (iconData?iconSize+gap:0);
  svg+=`<text x="${textX}" y="${baseY}" font-size="${fontSize}" font-weight="${fontWeight}" font-family="system-ui, sans-serif" fill="${textColor}">${text}</text>`;
  return {svg, w, h};
}
function pillSVG({x,y,text,fontSize=20,bg="#e6f2ff",textColor="#10324a",padX=12,padY=8,rx=14,fontWeight=700}){
  const font=`${fontWeight} ${fontSize}px system-ui, sans-serif`;
  const textW = textWidthPx(text, font);
  const w = padX*2 + textW;
  const h = padY*2 + fontSize;
  const baseY = y + padY + fontSize - 4;
  let svg=`<rect x="${x}" y="${y}" rx="${rx}" ry="${rx}" width="${w}" height="${h}" fill="${bg}" />`;
  svg+=`<text x="${x+padX}" y="${baseY}" font-size="${fontSize}" font-weight="${fontWeight}" font-family="system-ui, sans-serif" fill="${textColor}">${text}</text>`;
  return {svg, w, h};
}

/* build SVG with speed at TR, id at BR; skills TL; bottom element+gear */
function buildCardSVG(card){
  const W=700,H=980,pad=28,innerW=W-2*pad;   /* 桌面輸出放大一點，字清晰 */
  const st = ELEMENT_STYLE[card.element]||{};
  const bg=st.color||"#cfe2f3";
  const iconData=st.iconData||null;

  // Skills (TL) + Speed (TR)
  const skillsTopY = 70;
  const skillsRow = skillRowSVG(card.skills||[], pad, skillsTopY, innerW-150);
  const speedX = W - pad - 8;
  const speedY = skillsTopY + 34;

  // Bottom Element + Gear with pill + wrapped text
  const lineH=30, descFontPx=22, chipGap=14, blockGap=20, bottomPad=pad;
  const gearPillText = `${GEAR_EMOJI} ${card.gear}`;
  const gearPillTmp = pillSVG({x:pad+12,y:0,text:gearPillText,fontSize:22});
  const gearFirstIndent = gearPillTmp.w + chipGap;
  const gearLines = wrapWithFirstIndentByPx(card.gearText, gearFirstIndent, innerW, descFontPx);
  const gearTextH = gearLines.length * lineH;
  const gearBlockH = Math.max(gearPillTmp.h, lineH) + (gearLines.length?10:0) + gearTextH;
  const gearStartY = H - bottomPad - gearBlockH;

  const elemPillTmp = pillWithIconSVG({x:pad+12,y:0,text:card.element,iconData,fontSize:24});
  const elemFirstIndent = elemPillTmp.w + chipGap;
  const elemLines = wrapWithFirstIndentByPx(card.elementText, elemFirstIndent, innerW, descFontPx);
  const elemTextH = elemLines.length * lineH;
  const elemBlockH = Math.max(elemPillTmp.h, lineH) + (elemLines.length?10:0) + elemTextH;
  const elemStartY = gearStartY - blockGap - elemBlockH;

  const elemPill = pillWithIconSVG({x:pad+12,y:elemStartY,text:card.element,iconData,fontSize:24});
  const gearPill = pillSVG({x:pad+12,y:gearStartY,text:gearPillText,fontSize:22});

  let elemDescSVG=""; elemLines.forEach((t,i)=>{
    const x=(i===0)?(pad+12+elemPill.w+chipGap):(pad+12);
    const y=elemStartY + elemPill.h + 10 + i*lineH;
    elemDescSVG += `<text x="${x}" y="${y}" font-size="${descFontPx}" font-family="system-ui, sans-serif" fill="#10324a">${t}</text>`;
  });
  let gearDescSVG=""; gearLines.forEach((t,i)=>{
    const x=(i===0)?(pad+12+gearPill.w+chipGap):(pad+12);
    const y=gearStartY + gearPill.h + 10 + i*lineH;
    gearDescSVG += `<text x="${x}" y="${y}" font-size="${descFontPx}" font-family="system-ui, sans-serif" fill="#10324a">${t}</text>`;
  });

  // Card ID (BR)
  const idTextX = W - pad - 8;
  const idTextY = H - pad + 4;

  return `
<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}">
  <rect x="0" y="0" width="${W}" height="${H}" fill="${bg}"/>
  <rect x="12" y="12" width="${W-24}" height="${H-24}" rx="24" ry="24" fill="${bg}" stroke="#dfe7f1"/>

  ${skillsRow.svg}
  <text x="${speedX}" y="${speedY}" text-anchor="end" font-size="46" font-weight="800" font-family="system-ui, sans-serif" fill="#10324a">${card.speed}</text>

  ${elemPill.svg}
  ${elemDescSVG}

  ${gearPill.svg}
  ${gearDescSVG}

  <text x="${idTextX}" y="${idTextY}" text-anchor="end" font-size="16" font-family="system-ui, sans-serif" fill="#5a7b91">${card.id}</text>
</svg>`;
}

/* Download as JPG */
async function downloadCurrentBigCard(){
  if(!CURRENT_BIG_CARD) return;
  try{await ICONS_READY;}catch{}
  const svg=buildCardSVG(CURRENT_BIG_CARD);
  const blob=new Blob([svg],{type:"image/svg+xml"});
  const url=URL.createObjectURL(blob);
  const img=new Image();
  img.onload=()=>{
    const canvas=document.createElement("canvas");
    canvas.width=img.width;canvas.height=img.height;
    const ctx=canvas.getContext("2d");ctx.drawImage(img,0,0);
    URL.revokeObjectURL(url);
    const jpg=canvas.toDataURL("image/jpeg",0.96);
    const a=document.createElement("a");a.href=jpg;a.download=`${CURRENT_BIG_CARD.id}.jpg`;a.click();
  };
  img.src=url;
}
$("btnDownload").onclick=downloadCurrentBigCard;
</script>
</body>
</html>
